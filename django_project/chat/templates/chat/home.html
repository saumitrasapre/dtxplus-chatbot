{% extends "chat/base.html" %}
{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="content-section">
            <h2>New Chat</h2> 
            <div id="chat-box" class="chat-box">
                <!-- Chat messages will appear here -->
            </div>
            <div class="input-section">
                <textarea id="chat-input" class="form-control" rows="3" placeholder="Type your message..."></textarea>
                <small class="text-muted">Press <strong>Enter</strong> to send, or <strong>Shift + Enter</strong> for a new line.</small>
                <button id="send-btn" class="btn btn-primary mt-2">Send</button>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="content-section">
          <h4>Chat History</h4>
          <p class='text-muted'>Your chat history is visible here.
            {% for chat in chats %}
                <article class="media content-section">
                    <img class="rounded-circle article-img"  src="{{ chat.author.profile.image.url }}">
                    <div class="media-body">
                    <div class="article-metadata">
                        <small class="text-muted " >{{ chat.author }}</small>
                        <small class="text-muted">{{ chat.chat_date | date:"M d, Y, f a" }}</small>
                    </div>
                    <div class="row">
                        <div class="col-md-7">
                            <h5><a class="article-title" href="{% url 'chat-detail' chat.id %}">{{ chat.title }}</a></h5>
                        </div>
                        <div class="col-md-5">
                            <a class="btn btn-secondary btn-sm mt-1 mb-1" href="{% url 'chat-update' chat.id %}"><i class="fas fa-edit fa-sm"></i></a>
                            <a class="btn btn-danger btn-sm mt-1 mb-1" href="{% url 'chat-delete' chat.id %}"><i class="fas fa-trash fa-sm"></i></a>
                        </div>
                    </div>
                    <!-- <p class="article-content">{{ chat.content }}</p> -->
                    </div>
                </article>
            {% endfor %}
          </p>
        </div>
      </div>
</div>

<script>
    const roomName = "{{ user.username }}";
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/'+ roomName + '/' 
    );

    // Show "thinking" indicator as a chat bubble
    function showThinkingIndicator() {
        document.getElementById('chat-box').innerHTML += `
            <div class="bot-message thinking-bubble" id="thinking-indicator">
                <p><i class="fas fa-spinner fa-spin"></i> Thinking...</p>
            </div>
        `;
        scrollChatToBottom();
    }

    // Hide "thinking" indicator when response arrives
    function hideThinkingIndicator() {
        const thinkingIndicator = document.getElementById('thinking-indicator');
        if (thinkingIndicator) {
            thinkingIndicator.remove();
        }
    }

    // Scroll chat box to bottom
    function scrollChatToBottom() {
        const chatBox = document.getElementById('chat-box');
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    chatSocket.onopen = function(e) {
        console.log('WebSocket connection established');
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        hideThinkingIndicator();
        document.getElementById('chat-box').innerHTML += `
            <div class="bot-message chat-bubble">
                <p>${data.message}</p>
            </div>
        `;
        scrollChatToBottom();
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    // Handle Enter and Shift + Enter keypress for sending messages and newlines
    document.getElementById('chat-input').addEventListener('keydown', function (e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault(); // Prevent default newline action when sending

        const messageInputDom = document.getElementById('chat-input');
        let message = messageInputDom.value;

        if (message.trim() !== '') {
                // Replace newline characters with <br> for correct rendering
                const formattedMessage = message.replace(/\n/g, '<br>');

                document.getElementById('chat-box').innerHTML += `
                    <div class="user-message chat-bubble">
                        <p>${formattedMessage}</p>
                    </div>
                `;

                scrollChatToBottom();  // Scroll to the bottom of chat
                chatSocket.send(JSON.stringify({
                    'message': message
                }));

                messageInputDom.value = ''; // Clear the input after sending

                // Show thinking indicator after message is sent
                showThinkingIndicator();
            }
        }
    });


    document.getElementById('send-btn').onclick = function(e) {
        const messageInputDom = document.getElementById('chat-input');
        const message = messageInputDom.value;

        if (message.trim() !== '') {
            document.getElementById('chat-box').innerHTML += `
                <div class="user-message chat-bubble">
                    <p>${message}</p>
                </div>
            `;
            scrollChatToBottom();
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInputDom.value = '';

            // Show thinking indicator after message is sent
            showThinkingIndicator();
        }
    };
</script>
    
{% endblock content %}